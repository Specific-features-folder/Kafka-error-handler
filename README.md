# Kafka-error-handler

#### <br>Описание<br>
Необходимо реализовать обработчик ошибок для kafka, реализующий функциональные требования ниже.
* При возникновении ошибки при успешном вычитывании сообщения из кафки:
    * Если подключения к БД нет, то оффсет не должен двигаться и должны производиться повторные попытки обработать сообщение до тех пор, пока сообщение успешно не обработается (с отключенной БД, если это возможно), либо подключение к БД не появится.
    * Если подключение к БД есть, то должно быть произведено n дополнительных раз обработать сообщение. Если сообщение всё равно не обработается спустя n попыток при наличии подключения к БД, то оффсет должен быть увеличен, чтобы пропустить такую запись
* При возникновении ошибки при вычитке сообщения из кафки:
  * Если это ошибка десериализации, то оффсет должен быть увеличен, а информация об ошибке должна быть выведена в лог.
  * В остальных случаях оффсет не должен быть увеличен, сообщение должно повторно считываться и выводиться в лог сообщение об ошибке.

#### <br>Рассмотренные варианты реализации:<br>
1. Оффсет потребителя кафки должен быть увеличен после n попыток обработки при отключенной БД. Сообщения пропускаются. 
   (skipping-error-handler)
2. Оффсет потребителя кафки должен быть увеличен после n попыток обработки при отключенной БД. Сообщения сохраняются в отдельную таблицу в БД в формате json, откуда есть возможность запуска их повторной обработки.
   (raw-message-saving-error-handler)

#### <br>Причины создания:<br>
* При ошибках десериализации (если кто-то написал какой-то неверный формат сообщения в топик) не хотелось бы, чтобы сервис намертво вис пока не истечёт retention для сообщения с неверной структурой. 
* Если у сервиса отваливается БД не хотелось бы, чтобы сообщения из топиков пропускались и оставались без обработки
* Если возникает какая-то бизнесовая ошибка при обработке сообщения, а с инфраструктурой всё в порядке, опять же, не хотелось бы чтобы сервис вис пока не истечёт retention для такого сообщения
* N повторных попыток обработки необходимо: 
  * Для надёжности
  * Чтобы корректно обрабатывать кейс, когда ошибка в логике возникла из-за отключенной БД, а в момент обработки ошибки в обработчике ошибок БД уже восстановилась и обработчик считает, что ошибка не из-за отключенной БД

<br>Есть дополнительная ветка с реализацией KafkaListenerErrorHandler. Это совершенно другой тип обработчика ошибок в кафка. По сути, если обернуть в try/catch все строки внутри метода с @KafkaListener то получится тот же функционал. Его можно использовать отдельно или вкупе с CommonErrorHandler.
   Ветка с его реализацией называется kafka-listener-error-handler. Можно использовать для обобщения обработки ошибок и просто для чистоты в коде. Но при использовании CommonErrorHandler скорее всего он окажется не нужен, ведь нужно чтобы ошибки пробрасывались до CommonErrorHandler, а не проглатывались в KafkaListenerErrorHandler.

<br>Есть дополнительная ветка с реализацией обработчика ошибок кафки в старом АПИ spring-kafka, где требуется ручное управление offset consumer'а при ошибке.
    Ветка называется old-kafka-skipping-error-handler. Нужна, если используюте spring-boot +- 2.7.18 (spring-kafka +- 2.8) 

<br>`Реализации разделены по веткам, в main ветку слиты все ветки. Конкретные реализации нужно смотреть по отдельным веткам.`